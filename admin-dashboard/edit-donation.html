<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تعديل الحالة - يمن تبرع</title>
  
  <!-- ✅ 1. Bootstrap بدون مسافات زائدة -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" integrity="sha384-..." crossorigin="anonymous"/>
  
  <!-- ✅ 2. Font Awesome بدون مسافات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- ✅ 3. خط Tajawal -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: #f8f9fa; 
    }
    .form-container { 
      max-width: 800px; 
      margin: 30px auto; 
      padding: 20px; 
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .btn i {
      margin-left: 5px;
    }
    #imagePreview, #currentImage {
      max-height: 200px;
      border-radius: 8px;
      margin-top: 10px;
      display: block;
    }
    .current-img-label {
      font-weight: 600;
      margin-bottom: 5px;
    }
    /* إشعار نجاح */
    .toast {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 9999;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      opacity: 0;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
  </style>
</head>
<body>

  <!-- زر العودة -->
  <div class="container mt-3">
    <a href="manage-donations.html" class="btn btn-secondary">
      العودة
    </a>
  </div>

  <!-- نموذج التعديل -->
  <div class="form-container">
    <h2 class="text-center mb-4"><i class="fas fa-edit"></i> تعديل حالة تبرع</h2>
    <hr>

    <!-- رسالة نتيجة -->
    <div id="message" class="alert alert-danger d-none" role="alert">
      <i class="fas fa-exclamation-triangle"></i> <span id="message-text"></span>
    </div>

    <form id="editForm">
      <input type="hidden" name="id" id="donationId">

      <div class="mb-3">
        <label class="form-label">العنوان</label>
        <input type="text" class="form-control" name="title" required />
      </div>

      <div class="mb-3">
        <label class="form-label">الفئة</label>
        <select class="form-control" name="category" required>
          <option value="أيتام">أيتام</option>
          <option value="طبية">طبية</option>
          <option value="إغاثة">إغاثة</option>
          <option value="تعليم">تعليم</option>
          <option value="مشاريع صغيرة">مشاريع صغيرة</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">الموقع</label>
        <input type="text" class="form-control" name="location" required />
      </div>

      <div class="mb-3">
        <label class="form-label">عدد المستفيدين</label>
        <input type="number" class="form-control" name="beneficiaries" min="1" required />
      </div>

      <div class="mb-3">
        <label class="form-label">المبلغ المطلوب (ريال)</label>
        <input type="number" class="form-control" name="targetAmount" min="1" required />
      </div>

      <!-- رفع صورة جديدة -->
      <div class="mb-3">
        <label class="form-label">اختر صورة جديدة (اختياري)</label>
        <input type="file" class="form-control" name="imageUrl" accept="image/*" id="imageInput" />
        <div class="mt-2 text-center">
          <img id="imagePreview" alt="معاينة الصورة الجديدة" style="display: none;">
        </div>
      </div>

      <!-- الصورة الحالية -->
      <div class="mb-3" id="currentImageContainer">
        <label class="current-img-label">الصورة الحالية:</label>
        <img id="currentImage" alt="الصورة الحالية" style="max-height: 150px; border-radius: 8px;">
      </div>

      <div class="mb-3">
        <label class="form-label">الوصف التفصيلي</label>
        <textarea class="form-control" name="description" rows="4" required></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">تاريخ الانتهاء</label>
        <input type="date" class="form-control" name="endDate" required />
      </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
        <button type="submit" class="btn btn-success btn-lg">
          <i class="fas fa-save"></i> تحديث الحالة
        </button>
        <a href="manage-donations.html" class="btn btn-outline-secondary btn-lg">
          إلغاء
        </a>
      </div>
    </form>
  </div>

  <!-- إشعار نجاح -->
  <div class="toast" id="successToast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body bg-success text-white rounded">
        <i class="fas fa-check-circle"></i> تم تحديث الحالة بنجاح!
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const token = localStorage.getItem('adminToken');

    if (!token) {
      alert('يرجى تسجيل الدخول أولاً');
      window.location.href = 'login.html';
    }

    // تحميل بيانات الحالة
    window.onload = async () => {
      try {
        const res = await fetch(`http://localhost:3000/api/donations/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('فشل جلب البيانات');

        const d = await res.json();

        document.getElementById('donationId').value = d.id;
        document.querySelector('[name="title"]').value = d.title;
        document.querySelector('[name="category"]').value = d.category;
        document.querySelector('[name="location"]').value = d.location;
        document.querySelector('[name="beneficiaries"]').value = d.beneficiaries;
        document.querySelector('[name="targetAmount"]').value = d.targetAmount;
        document.querySelector('[name="description"]').value = d.description;
        document.querySelector('[name="endDate"]').value = d.endDate.split('T')[0];

        if (d.imageUrl) {
          const currentImg = document.getElementById('currentImage');
          // ✅ استخدام الرابط الكامل
          currentImg.src = `http://localhost:3000${d.imageUrl}`;
          currentImg.style.display = 'block';
        }
      } catch (error) {
        console.error('فشل تحميل البيانات:', error);
        alert('فشل تحميل بيانات الحالة');
        window.location.href = 'manage-donations.html';
      }
    };

    // معاينة الصورة الجديدة
    document.getElementById('imageInput').onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        alert('حجم الصورة كبير جدًا');
        e.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        const preview = document.getElementById('imagePreview');
        preview.src = event.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    };

    // إرسال النموذج
    document.getElementById('editForm').onsubmit = async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);

      try {
        const res = await fetch(`http://localhost:3000/api/donations/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
            // ❌ لا تضيف Content-Type — يُحدد تلقائيًا
          },
          body: formData
        });

        if (res.ok) {
          // ✅ إظهار الإشعار
          const toast = document.getElementById('successToast');
          toast.classList.add('show');

          setTimeout(() => {
            toast.classList.remove('show');
          }, 3000);

          setTimeout(() => {
            window.location.href = 'manage-donations.html';
          }, 1500);
        } else {
          const error = await res.json();
          document.getElementById('message-text').textContent = error.message || 'خطأ غير معروف';
          document.getElementById('message').classList.remove('d-none');
        }
      } catch (err) {
        console.error('خطأ في الاتصال:', err);
        document.getElementById('message-text').textContent = 'تعذر الاتصال بالخادم';
        document.getElementById('message').classList.remove('d-none');
      }
    };
  </script>
</body>
</html>