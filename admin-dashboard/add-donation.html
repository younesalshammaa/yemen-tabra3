<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>إضافة حالة تبرع - يمن تبرع</title>
  
  <!-- ✅ 1. Bootstrap بدون مسافات زائدة -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" integrity="sha384-..." crossorigin="anonymous"/>
  
  <!-- ✅ 2. Font Awesome بدون مسافات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- ✅ 3. خط Tajawal -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: #f8f9fa; 
    }
    .form-container { 
      max-width: 800px; 
      margin: 30px auto; 
      padding: 20px; 
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .btn i {
      margin-left: 5px;
    }
    #imagePreview {
      max-height: 200px;
      margin-top: 10px;
      border-radius: 8px;
      display: none;
      object-fit: cover;
    }
    .required::after {
      content: " *";
      color: red;
    }
    .alert {
      margin: 10px 0;
    }
    /* تنسيق الإشعار الجذاب */
    .toast {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 9999;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      opacity: 0;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
  </style>
</head>
<body>

  <!-- ✅ زر العودة فقط -->
  <div class="container mt-3">
    <a href="index.html" class="btn btn-secondary">
      العودة
    </a>
  </div>

  <!-- نموذج الإضافة -->
  <div class="form-container">
    <h2 class="text-center mb-4"><i class="fas fa-plus-circle"></i> إضافة حالة تبرع جديدة</h2>
    <hr>

    <!-- رسالة نتيجة -->
    <div id="message" class="alert alert-danger d-none" role="alert">
      <i class="fas fa-exclamation-triangle"></i> <span id="message-text"></span>
    </div>

    <form id="donationForm">
      <!-- العنوان -->
      <div class="mb-3">
        <label class="form-label required">العنوان</label>
        <input type="text" class="form-control" name="title" required />
      </div>

      <!-- الفئة -->
      <div class="mb-3">
        <label class="form-label required">الفئة</label>
        <select class="form-control" name="category" required>
          <option value="أيتام">أيتام</option>
          <option value="طبية">طبية</option>
          <option value="إغاثة">إغاثة</option>
          <option value="تعليم">تعليم</option>
          <option value="مشاريع صغيرة">مشاريع صغيرة</option>
        </select>
      </div>

      <!-- الموقع -->
      <div class="mb-3">
        <label class="form-label required">الموقع</label>
        <input type="text" class="form-control" name="location" required />
      </div>

      <!-- عدد المستفيدين -->
      <div class="mb-3">
        <label class="form-label required">عدد المستفيدين</label>
        <input type="number" class="form-control" name="beneficiaries" min="1" required />
      </div>

      <!-- المبلغ المطلوب -->
      <div class="mb-3">
        <label class="form-label required">المبلغ المطلوب (ريال)</label>
        <input type="number" class="form-control" name="targetAmount" min="1" required />
      </div>

      <!-- رفع الصورة من الجهاز -->
      <div class="mb-3">
        <label class="form-label required">اختر صورة من الجهاز</label>
        <input type="file" class="form-control" name="imageUrl" accept="image/*" id="imageInput" required />
        <div class="mt-2 text-center">
          <img id="imagePreview" alt="معاينة الصورة" />
        </div>
      </div>

      <!-- الوصف -->
      <div class="mb-3">
        <label class="form-label required">الوصف التفصيلي</label>
        <textarea class="form-control" name="description" rows="4" required></textarea>
      </div>

      <!-- تاريخ الانتهاء -->
      <div class="mb-3">
        <label class="form-label required">تاريخ الانتهاء</label>
        <input type="date" class="form-control" name="endDate" required />
      </div>

      <!-- أزرار الإرسال -->
      <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
        <button type="submit" class="btn btn-success btn-lg">
          <i class="fas fa-paper-plane"></i> إضافة الحالة
        </button>
        <a href="index.html" class="btn btn-outline-secondary btn-lg">
          إلغاء
        </a>
      </div>
    </form>
  </div>

  <!-- ✅ إشعار أنيق (Toast) -->
  <div class="toast" id="successToast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body bg-success text-white rounded">
        <i class="fas fa-check-circle"></i> تم إضافة الحالة بنجاح!
      </div>
    </div>
  </div>

  <script>
    // إخفاء الرسالة
    const hideMessage = () => {
      document.getElementById('message').classList.add('d-none');
    };

    // عرض الرسالة
    const showMessage = (text, type = 'danger') => {
      const messageDiv = document.getElementById('message');
      const messageText = document.getElementById('message-text');
      messageText.textContent = text;
      messageDiv.className = `alert alert-${type}`;
      messageDiv.classList.remove('d-none');
    };

    // معاينة الصورة قبل الرفع
    document.getElementById('imageInput').onchange = function(e) {
      hideMessage();
      const file = e.target.files[0];
      if (!file) return;

      // التحقق من الحجم (لا يزيد عن 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showMessage('حجم الصورة كبير جدًا. يرجى اختيار صورة أقل من 5 ميغابايت', 'warning');
        e.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        const preview = document.getElementById('imagePreview');
        preview.src = event.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    };

    // إرسال النموذج
    document.getElementById('donationForm').onsubmit = async (e) => {
      e.preventDefault();
      hideMessage();

      const token = localStorage.getItem('adminToken');
      if (!token) {
        alert('يرجى تسجيل الدخول أولاً');
        window.location.href = 'login.html';
        return;
      }

      // استخدام FormData لرفع الملف
      const formData = new FormData(e.target);

      try {
        const res = await fetch('http://localhost:3000/api/donations', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
            // ❌ لا تضيف Content-Type — يُحدد تلقائيًا
          },
          body: formData
        });

        if (res.ok) {
          // ✅ إظهار الإشعار الأنيق
          const toast = document.getElementById('successToast');
          toast.classList.add('show');

          // إخفاء الإشعار بعد 3 ثواني
          setTimeout(() => {
            toast.classList.remove('show');
          }, 3000);

          // إعادة التوجيه بعد 1.5 ثانية
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1500);
        } else {
          const error = await res.json();
          showMessage('فشل الإضافة: ' + (error.message || 'خطأ غير معروف'), 'danger');
        }
      } catch (err) {
        console.error('خطأ في الاتصال:', err);
        showMessage('تعذر الاتصال بالخادم. تأكد من أن الخادم يعمل', 'danger');
      }
    };
  </script>
</body>
</html>