<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>إدارة الحالات - يمن تبرع</title>
  
  <!-- ✅ 1. Bootstrap بدون مسافات زائدة -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" integrity="sha384-..." crossorigin="anonymous"/>
  
  <!-- ✅ 2. Font Awesome بدون مسافات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- ✅ 3. خط Tajawal -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: #f8f9fa; 
      padding-top: 20px;
    }
    .container {
      max-width: 1200px;
    }
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: white;
    }
    .status-active { background: #28a745; }
    .status-completed { background: #17a2b8; }
    .status-paused { background: #ffc107; color: #000; }
    .progress { height: 12px; }
    .btn i {
      margin-left: 5px;
    }
    .text-center { text-align: center !important; }
    .table th, .table td {
      vertical-align: middle;
      text-align: center;
    }
    .alert {
      margin: 20px;
    }
    .table img {
      height: 60px;
      width: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #eee;
    }
    .fw-bold {
      font-weight: 600 !important;
    }
  </style>
</head>
<body>

  <!-- ✅ زر العودة إلى الصفحة الرئيسية -->
  <div class="container mt-3">
    <a href="index.html" class="btn btn-secondary">
      العودة
    </a>
  </div>

  <div class="container mt-4">
    
    <!-- عنوان الصفحة وأزرار -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-list"></i> إدارة حالات التبرع</h2>
      <div>
        <button onclick="loadDonations()" class="btn btn-outline-secondary btn-sm me-2">
          <i class="fas fa-sync"></i> تحديث
        </button>
        <a href="add-donation.html" class="btn btn-primary">
          <i class="fas fa-plus"></i> إضافة حالة جديدة
        </a>
      </div>
    </div>

    <!-- رسالة نتيجة العمليات -->
    <div id="message" class="alert alert-success d-none" role="alert">
      <i class="fas fa-check-circle"></i> <span id="message-text"></span>
    </div>

    <!-- جدول الحالات -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover shadow-sm">
        <thead class="table-dark">
          <tr>
            <th>الصورة</th>
            <th>العنوان</th>
            <th>الفئة</th>
            <th>الموقع</th>
            <th>المبلغ (ريال)</th>
            <th>التقدم</th>
            <th>الحالة</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="donations-table">
          <tr>
            <td colspan="8" class="text-center text-muted">جارٍ تحميل البيانات...</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <script>
    const token = localStorage.getItem('adminToken');
    if (!token) {
      alert('يرجى تسجيل الدخول أولاً');
      window.location.href = 'login.html';
      throw new Error('غير مصرح');
    }

    // عرض الرسالة
    const showMessage = (text, type = 'success') => {
      const messageDiv = document.getElementById('message');
      const messageText = document.getElementById('message-text');
      messageText.textContent = text;
      messageDiv.className = `alert alert-${type} d-block`;
      setTimeout(() => {
        messageDiv.classList.add('d-none');
      }, 5000);
    };

    // تحميل الحالات
    const loadDonations = async () => {
      document.getElementById('donations-table').innerHTML = `
        <tr><td colspan="8" class="text-center text-muted">جارٍ التحميل...</td></tr>
      `;

      try {
        const res = await fetch('http://localhost:3000/api/donations', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
          throw new Error('فشل جلب البيانات');
        }

        const donations = await res.json();
        const container = document.getElementById('donations-table');
        container.innerHTML = '';

        if (donations.length === 0) {
          container.innerHTML = `
            <tr><td colspan="8" class="text-center text-muted">لا توجد حالات متاحة حاليًا</td></tr>
          `;
          return;
        }

        donations.forEach(d => {
          const progress = d.targetAmount > 0 ? (d.raisedAmount / d.targetAmount) * 100 : 0;
          const statusClass = d.status === 'active' ? 'status-active' :
                             d.status === 'completed' ? 'status-completed' : 'status-paused';
          const statusText = d.status === 'active' ? 'نشطة' : 
                            d.status === 'completed' ? 'مكتملة' : 'معلقة';

          // ✅ استخدام الرابط الكامل من الخادم
          const imageUrl = d.imageUrl && d.imageUrl.trim() !== ''
            ? `http://localhost:3000${d.imageUrl.trim()}`
            : 'https://via.placeholder.com/60x60?text=لا+توجد+صورة';

          container.innerHTML += `
            <tr>
              <td>
                <img src="${imageUrl}" 
                     alt="صورة الحالة" 
                     onerror="this.src='https://via.placeholder.com/60x60?text=خطأ+في+الصورة'; this.onerror=null;"
                     style="width: 60px; height: 60px;">
              </td>
              <td class="fw-bold">${d.title}</td>
              <td>${d.category}</td>
              <td>${d.location}</td>
              <td>${d.raisedAmount.toLocaleString()} / ${d.targetAmount.toLocaleString()}</td>
              <td>
                <div class="progress" style="height: 12px;">
                  <div class="progress-bar bg-success" style="width: ${Math.min(progress, 100)}%"></div>
                </div>
                <small class="text-muted">${Math.min(progress, 100).toFixed(1)}%</small>
              </td>
              <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td>
                <button onclick="editDonation(${d.id})" class="btn btn-sm btn-warning me-1" title="تعديل">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteDonation(${d.id})" class="btn btn-sm btn-danger" title="حذف">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      } catch (error) {
        console.error('خطأ في تحميل الحالات:', error);
        document.getElementById('donations-table').innerHTML = `
          <tr>
            <td colspan="8" class="text-center text-danger">
              ❌ تعذر تحميل البيانات. تأكد من أن الخادم يعمل.
            </td>
          </tr>
        `;
      }
    };

    // تعديل الحالة
    const editDonation = (id) => {
      window.location.href = `edit-donation.html?id=${id}`;
    };

    // حذف الحالة
    const deleteDonation = async (id) => {
      const confirmed = confirm('هل أنت متأكد أنك تريد حذف هذه الحالة؟\nلا يمكن التراجع عن هذه العملية.');
      if (!confirmed) return;

      try {
        const res = await fetch(`http://localhost:3000/api/donations/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (res.ok) {
          showMessage('تم حذف الحالة بنجاح!', 'success');
          loadDonations(); // إعادة التحميل
        } else {
          const error = await res.json();
          showMessage('فشل الحذف: ' + (error.message || 'خطأ غير معروف'), 'danger');
        }
      } catch (err) {
        console.error('خطأ في الحذف:', err);
        showMessage('فشل الاتصال بالخادم. تأكد من أن الخادم يعمل.', 'danger');
      }
    };

    // تحميل البيانات عند فتح الصفحة
    window.onload = () => {
      loadDonations();
    };
  </script>
</body>
</html>